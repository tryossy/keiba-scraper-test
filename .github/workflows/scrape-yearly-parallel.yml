name: Yearly Horse Racing Data Scrape (12 Months Parallel)

on:
  # 手動実行のみ（年間データの取得は手動トリガー推奨）
  workflow_dispatch:
    inputs:
      year:
        description: '取得する年（例: 2024）'
        required: true
        default: '2024'
      start_month:
        description: '開始月（1-12、デフォルト: 1）'
        required: false
        default: '1'
      end_month:
        description: '終了月（1-12、デフォルト: 12）'
        required: false
        default: '12'

jobs:
  # ジョブ1: 月のマトリックスを生成
  generate-matrix:
    runs-on: ubuntu-latest
    outputs:
      months: ${{ steps.generate.outputs.months }}

    steps:
      - name: 月マトリックスを生成
        id: generate
        run: |
          import json
          import os

          year = int('${{ github.event.inputs.year }}')
          start_month = int('${{ github.event.inputs.start_month }}')
          end_month = int('${{ github.event.inputs.end_month }}')

          months = []
          for month in range(start_month, end_month + 1):
              months.append({
                  'year': year,
                  'month': month,
                  'year_month': f'{year}-{month:02d}',
                  'name': f'{year}年{month}月'
              })

          # GitHub Actions の出力に設定
          output = json.dumps(months)
          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              f.write(f"months={output}\n")

          print(f"生成された月: {len(months)}個")
          for m in months:
              print(f"  {m['name']}: {m['year_month']}")

        shell: python

  # ジョブ2: 並列スクレイピング（最大6ジョブ同時）
  scrape:
    needs: generate-matrix
    runs-on: ubuntu-latest
    timeout-minutes: 360  # 6時間

    strategy:
      # 並列実行の設定
      max-parallel: 6     # 最大6ジョブ同時実行
      fail-fast: false    # 1つ失敗しても他は続行
      matrix:
        month: ${{ fromJson(needs.generate-matrix.outputs.months) }}

    steps:
      - name: リポジトリをチェックアウト
        uses: actions/checkout@v4

      - name: Python 3.11 のセットアップ
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: 依存関係のインストール
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: config.json の作成
        run: |
          if [ -f config.json.example ]; then
            cp config.json.example config.json
          else
            cat > config.json << 'EOF'
          {
            "request_settings": {
              "min_interval": 1.5,
              "max_requests_per_day": 40,
              "max_requests_weekday": 8000,
              "max_requests_weekend": 150
            }
          }
          EOF
          fi

      - name: データスクレイピング（${{ matrix.month.name }}）
        run: |
          python scrape_monthly_local.py --year-month ${{ matrix.month.year_month }}
        env:
          PYTHONUNBUFFERED: 1

      - name: データサマリーの表示
        run: |
          echo "=== スクレイピング完了: ${{ matrix.month.name }} ==="

          # data/html/race/ 配下のファイル数を確認
          if [ -d "data/html/race" ]; then
            MONTH_PREFIX="${{ matrix.month.year }}$(printf '%02d' ${{ matrix.month.month }})"
            FILE_COUNT=$(find data/html/race -name "${MONTH_PREFIX}*.bin" 2>/dev/null | wc -l)
            echo "取得ファイル数: $FILE_COUNT"

            if [ $FILE_COUNT -gt 0 ]; then
              DISK_USAGE=$(du -sh data/html/race | cut -f1)
              echo "ディスク使用量: $DISK_USAGE"
            else
              echo "警告: データが取得できませんでした"
            fi
          else
            echo "警告: data/html/race ディレクトリが存在しません"
          fi

      # Google Drive にアップロード
      - name: rclone のインストール
        if: env.RCLONE_CONFIG != ''
        run: |
          curl https://rclone.org/install.sh | sudo bash
        env:
          RCLONE_CONFIG: ${{ secrets.RCLONE_CONFIG }}

      - name: rclone 設定
        if: env.RCLONE_CONFIG != ''
        run: |
          mkdir -p ~/.config/rclone
          cat > ~/.config/rclone/rclone.conf << 'EOF'
          ${{ secrets.RCLONE_CONFIG }}
          EOF
        env:
          RCLONE_CONFIG: ${{ secrets.RCLONE_CONFIG }}

      - name: Google Drive にアップロード
        if: env.RCLONE_CONFIG != ''
        run: |
          # data/html/race/ 配下の該当月のファイルをアップロード
          if [ -d "data/html/race" ]; then
            MONTH_PREFIX="${{ matrix.month.year }}$(printf '%02d' ${{ matrix.month.month }})"
            rclone copy \
              data/html/race/ \
              gdrive:keiba-data/html/race/ \
              --include "${MONTH_PREFIX}*.bin"

            echo "Google Drive へのアップロード完了"
            echo "保存先: gdrive:keiba-data/html/race/"
          else
            echo "警告: data/html/race ディレクトリが存在しません"
          fi
        env:
          RCLONE_CONFIG: ${{ secrets.RCLONE_CONFIG }}

      # ログのみアップロード（データは含まない）
      - name: ログのアップロード
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: scraping-logs-${{ matrix.month.year_month }}
          path: |
            *.log
          retention-days: 7
          if-no-files-found: ignore

