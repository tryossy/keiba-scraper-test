name: Monthly Scrape (Local Scraper)

on:
  # 毎月1日 午前2時（UTC）に実行
  schedule:
    - cron: '0 2 1 * *'

  # 手動実行を許可
  workflow_dispatch:
    inputs:
      year_month:
        description: '取得する年月（例: 2024-12）'
        required: true
        default: '2024-12'

jobs:
  scrape:
    runs-on: ubuntu-latest
    timeout-minutes: 360  # 6時間

    steps:
      - name: リポジトリをチェックアウト
        uses: actions/checkout@v4

      - name: Python 3.11 のセットアップ
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: 依存関係のインストール
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: config.json の作成
        run: |
          # config.json.example が存在する場合はコピー
          if [ -f config.json.example ]; then
            cp config.json.example config.json
          else
            # 最小限の設定を作成
            cat > config.json << 'EOF'
          {
            "request_settings": {
              "min_interval": 1.5,
              "max_requests_per_day": 40,
              "max_requests_weekday": 8000,
              "max_requests_weekend": 150
            }
          }
          EOF
          fi

      - name: 年月の決定
        id: date
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "year_month=${{ github.event.inputs.year_month }}" >> $GITHUB_OUTPUT
          else
            # 前月を取得（スケジュール実行時）
            echo "year_month=$(date -d 'last month' +%Y-%m)" >> $GITHUB_OUTPUT
          fi

      - name: データスクレイピング
        run: |
          python scrape_monthly_local.py --year-month ${{ steps.date.outputs.year_month }}
        env:
          PYTHONUNBUFFERED: 1

      - name: スクレイピング結果の確認
        run: |
          echo "=== スクレイピング完了 ==="
          echo "対象月: ${{ steps.date.outputs.year_month }}"

          # data/html/race/ 配下のファイル数を確認
          if [ -d "data/html/race" ]; then
            FILE_COUNT=$(find data/html/race -name "*.bin" | wc -l)
            echo "取得ファイル数: $FILE_COUNT"

            # ディスク使用量
            DISK_USAGE=$(du -sh data/html/race | cut -f1)
            echo "ディスク使用量: $DISK_USAGE"
          else
            echo "警告: data/html/race ディレクトリが存在しません"
          fi

      # オプション: Google Drive にアップロード
      - name: rclone のインストール
        if: env.RCLONE_CONFIG != ''
        run: |
          curl https://rclone.org/install.sh | sudo bash
        env:
          RCLONE_CONFIG: ${{ secrets.RCLONE_CONFIG }}

      - name: rclone 設定
        if: env.RCLONE_CONFIG != ''
        env:
          RCLONE_CONFIG: ${{ secrets.RCLONE_CONFIG }}
        run: |
          mkdir -p ~/.config/rclone
          echo "$RCLONE_CONFIG" > ~/.config/rclone/rclone.conf
          echo "rclone設定完了"

      - name: Google Drive にアップロード
        if: env.RCLONE_CONFIG != ''
        run: |
          YEAR_MONTH="${{ steps.date.outputs.year_month }}"
          YEAR=$(echo $YEAR_MONTH | cut -d'-' -f1)
          MONTH=$(echo $YEAR_MONTH | cut -d'-' -f2)

          # data/html/race/ 配下を年月ごとにアップロード
          if [ -d "data/html/race" ]; then
            # 該当月のファイルのみアップロード（YYYYMM*.bin）
            MONTH_PREFIX="${YEAR}${MONTH}"
            rclone copy \
              data/html/race/ \
              gdrive:keiba-data/html/race/ \
              --include "${MONTH_PREFIX}*.bin"

            echo "Google Drive へのアップロード完了"
            echo "保存先: gdrive:keiba-data/html/race/"
          else
            echo "警告: data/html/race ディレクトリが存在しません"
          fi

      # ログのみアップロード（データは含まない）
      - name: ログのアップロード
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: scraping-logs-${{ steps.date.outputs.year_month }}
          path: |
            logs/*.log
          retention-days: 7
          if-no-files-found: ignore

      - name: スクレイピング結果の通知
        if: always()
        run: |
          YEAR_MONTH="${{ steps.date.outputs.year_month }}"

          if [ -d "data/html/race" ]; then
            FILE_COUNT=$(find data/html/race -name "*.bin" | wc -l)
            if [ $FILE_COUNT -gt 0 ]; then
              echo "✅ スクレイピング成功: $YEAR_MONTH ($FILE_COUNT ファイル)"
            else
              echo "⚠️ スクレイピング実行したが、データが取得できませんでした: $YEAR_MONTH"
            fi
          else
            echo "❌ スクレイピング失敗: $YEAR_MONTH"
            exit 1
          fi
